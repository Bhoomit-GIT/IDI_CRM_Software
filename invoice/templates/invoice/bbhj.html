{% extends "base.html" %}
{% block content %}

<form method="post" action="{% url 'invoice:invoice-create' %}">
    {% csrf_token %}
    {{ invoice_form.as_p }}

    <table id="invoice-items-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Taxable</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="invoice-form-list">
            {{ invoice_item_formset.management_form }}
            {% for form in invoice_item_formset %}
            <tr class="invoice-item-form">
                <td>{{ form.product }}</td>
                <td>{{ form.quantity }}</td>
                <td>{{ form.rate }}</td>
                <td>{{ form.taxable }}</td>
                <td>{{ form.cgst }}</td>
                <td>{{ form.sgst }}</td>
                <td>{{ form.igst }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Empty row template as a <tr> element -->
    <table style="display: none;">
        <tbody>
            <tr id="empty-form" class="invoice-item-form">
                <td>{{ invoice_item_formset.empty_form.product }}</td>
                <td>{{ invoice_item_formset.empty_form.quantity }}</td>
                <td>{{ invoice_item_formset.empty_form.rate }}</td>
                <td>{{ invoice_item_formset.empty_form.taxable }}</td>
                <td>{{ invoice_item_formset.empty_form.cgst }}</td>
                <td>{{ invoice_item_formset.empty_form.sgst }}</td>
                <td>{{ invoice_item_formset.empty_form.igst }}</td>
                <td><button type="button" onclick="removeRow(this)">Remove</button></td>
            </tr>
        </tbody>
    </table>

    <button id="add-more">Add More</button>
    <input type="hidden" id="id_form-TOTAL_FORMS" value="{{ invoice_item_formset.total_form_count }}">
    <button type="submit">Submit</button>
</form>

<script>
    const addMorebtn = document.getElementById('add-more')
    const totalNewForms = document.getElementById('id_form-TOTAL_FORMS')

    addMorebtn.addEventListener('click', add_new_form)

    function add_new_form(event) {
        if (event) {
            event.preventDefault()
        }
        const currentInvoiceForms = document.getElementsByClassName('invoice-item-form')
        const currentFormCount = currentInvoiceForms.length
        const formCopyTarget = document.getElementById('invoice-form-list')
        const copyemptyFormEl = document.getElementById('empty-form').cloneNode(true)
        copyemptyFormEl.removeAttribute('id') // Remove ID from the cloned element
        copyemptyFormEl.style.display = '' // Make it visible
        const regex = new RegExp('__prefix__', 'g')
        copyemptyFormEl.innerHTML = copyemptyFormEl.innerHTML.replace(regex, currentFormCount)
        totalNewForms.setAttribute('value', currentFormCount + 1)
        formCopyTarget.appendChild(copyemptyFormEl) // Use appendChild to add directly as the last row
    }

    function removeRow(button) {
        const row = button.parentNode.parentNode
        row.parentNode.removeChild(row)
        const currentFormCount = document.getElementsByClassName('invoice-item-form').length
        totalNewForms.setAttribute('value', currentFormCount)
    }
</script>

{% endblock content %}