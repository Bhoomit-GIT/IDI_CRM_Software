{% extends "base.html" %}
{% block content %}
<h1>Create Invoice</h1>

<form method="post" action="{% url 'invoice:invoice-create' %}">
    {% csrf_token %}
    
    {{ invoice_form.as_p }}

    <table id="invoice-items-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Taxable</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody id="invoice_items">
            {{ invoice_item_formset.management_form }}
            {% for form in invoice_item_formset %}
                <tr class="invoice-item">
                    <td>{{ form.product }}</td>
                    <td>{{ form.quantity }}</td>
                    <td>{{ form.rate }}</td>
                    <td>{{ form.taxable }}</td>
                    <td>{{ form.cgst }}</td>
                    <td>{{ form.sgst }}</td>
                    <td>{{ form.igst }}</td>
                    <td>
                        <button type="button" class="remove-item-btn">Remove</button>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Add Product button to add a new row -->
    <button 
        type="button" 
        id="add-product-btn"
        hx-get="{% url 'invoice:add_product' %}?form_count={{ invoice_item_formset.total_form_count }}"
        hx-target="#invoice_items" 
        hx-swap="beforeend">
        Add Product
    </button>

    <button type="submit">Submit</button>
</form>

<script>
    document.getElementById('add-product-btn').addEventListener('click', function () {
        const formCountInput = document.getElementById('id_invoiceitem_set-TOTAL_FORMS');
        formCountInput.value = parseInt(formCountInput.value) + 1;
    });

    document.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('remove-item-btn')) {
            event.target.closest('tr').remove();
            const formCountInput = document.getElementById('id_invoiceitem_set-TOTAL_FORMS');
            formCountInput.value = parseInt(formCountInput.value) - 1;
        }
    });
</script>

{% endblock %}