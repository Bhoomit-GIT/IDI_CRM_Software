{% extends "base.html" %}
{% block content %}
<h1>Create Invoice</h1>

<form method="post" action="{% url 'invoice:invoice-create' %}">
    {% csrf_token %}
    
    {{ invoice_form.as_p }}

    <h2>Invoice Items</h2>
    
    <!-- Render management form -->
    {{ invoice_item_formset.management_form }}

    <div id="invoice-items-container">
        {% for form in invoice_item_formset %}
            <div class="invoice-item-form">
                {{ form.as_p }}
            </div>
        {% endfor %}
    </div>

    <!-- Hidden empty form template -->
    <div id="empty-form-template" style="display: none;">
        {{ invoice_item_formset.empty_form.as_p }}
    </div>

    <button type="button" id="add-product">Add Product</button>
    <button type="submit">Submit</button>
    <input type="hidden" name="invoiceitem_set-TOTAL_FORMS" id="id_invoiceitem_set-TOTAL_FORMS" value="1">
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    const addProductButton = document.getElementById('add-product');
    const invoiceItemsContainer = document.getElementById('invoice-items-container');
    const emptyFormTemplate = document.getElementById('empty-form-template').cloneNode(true);
    const totalForms = document.getElementById('id_invoiceitem_set-TOTAL_FORMS');

    // Ensure totalForms exists
    if (!totalForms) {
        console.error('TOTAL_FORMS field not found');
        return;
    }

    addProductButton.addEventListener('click', function (e) {
        e.preventDefault();

        // Clone the empty form template
        const newForm = emptyFormTemplate.cloneNode(true);
        newForm.style.display = '';  // Make it visible

        // Update the new form with the correct form index
        const formIndex = totalForms.value;
        newForm.innerHTML = newForm.innerHTML.replace(/__prefix__/g, formIndex);

        // Append the new form to the container
        invoiceItemsContainer.appendChild(newForm);

        // Increment the TOTAL_FORMS count
        totalForms.value = parseInt(totalForms.value) + 1;
    });
});
</script>

{% endblock content %}