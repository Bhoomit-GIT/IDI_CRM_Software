{% extends "base.html" %}
{% block content %}

<form method="post" action="{% url 'invoice:invoice-create' %}">
    {% csrf_token %}
    
    {{ invoice_form.as_p }}

    <table id="invoice-items-table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Rate</th>
                <th>Taxable</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Remove</th>
            </tr>
        </thead>
        <tbody>
            {{ invoice_item_formset.management_form }}
            {% for form in invoice_item_formset %}
                <tr class="invoice-item">
                    <td>{{ form.product }}</td>
                    <td>{{ form.quantity }}</td>
                    <td>{{ form.rate }}</td>
                    <td>{{ form.taxable }}</td>
                    <td>{{ form.cgst }}</td>
                    <td>{{ form.sgst }}</td>
                    <td>{{ form.igst }}</td>
                    <td>
                        {% if forloop.first %}
                            <button type="button" class="remove-item" disabled>Remove</button>
                        {% else %}
                            <button type="button" class="remove-item">Remove</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <button type="button" id="add-product">Add Product</button>
    <button type="submit">Submit</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
    let formIndex = {{ invoice_item_formset.total_form_count }};
    const tableBody = document.querySelector('#invoice-items-table tbody');
    const addButton = document.getElementById('add-product');

    addButton.addEventListener('click', function () {
        const newRow = document.querySelector('.invoice-item:last-child').cloneNode(true);
        
        // Update the index for the new row
        newRow.innerHTML = newRow.innerHTML.replace(/invoiceitem_set-(\d+)-/g, 'invoiceitem_set-' + formIndex + '-');

        // Reset input values in the new row
        newRow.querySelectorAll('input').forEach(input => {
            input.value = '';
        });

        // Enable the remove button for the new row
        const removeButton = newRow.querySelector('.remove-item');
        removeButton.disabled = false;

        // Append the new row to the table
        tableBody.appendChild(newRow);
        formIndex++;
    });

    tableBody.addEventListener('click', function (event) {
        if (event.target.classList.contains('remove-item')) {
            const row = event.target.closest('tr');
            row.remove();
        }
    });
});
</script>

{% endblock content %}